Планировщик и сплайнер
======================

Look-ahead планировщик анализирует очередь сегментов, вычисляя допустимые
скорости на границах с учётом ограничений по скорости, ускорению и рывку. Для
сплайнов используется метод добавочного time-scaling Shin–McKay. В документации
приведены основные формулы, реализованные в коде.

Дополнительно встроенный TinyML оптимизатор анализирует кривизну, длину дуги и
номинальные ограничения, выдавая корректирующий множитель скорости перед
генерацией S-кривой. Нейросеть представляет собой однослойный персептрон в
фиксированной точности Q16.16, что позволяет запускать инференс в каждом цикле
без динамических аллокаций.

По запросу пользователя (опция ``--enable-brachisto`` в ``configure``) сплайнер
строит брахистохронные траектории. Решение основано на классической циклоиде
И. Бернулли: для двух точек, разделённых горизонталью ``L`` и перепадом высот
``H``, подбирается параметр ``\theta`` из уравнения

.. math::

   (\theta - \sin \theta) - \frac{L}{H} (1 - \cos \theta) = 0,

после чего радиус генерирующей окружности равен

.. math::

   R = \frac{H}{1 - \cos \theta},

а сама траектория описывается параметризацией

.. math::

   x(\tau) = R (\theta \tau - \sin (\theta \tau)), \qquad
   y(\tau) = R (1 - \cos (\theta \tau)).

Полученные координаты проецируются в плоскость, определённую горизонтальной
составляющей между узлами и вектором гравитации (ось ``-Z``). Длина дуги
вычисляется замкнутой формулой :math:`s = 4 R (1 - \cos (\theta / 2))`, что
позволяет интегрировать брахистохрону в общую систему time-scaling без
численного интегрирования.

Модуль :c:func:`gcode_parse_line` поддерживает полный набор команд рабочего
профиля станка: модальные переключения G20/G21 и G90/G91, линейные перемещения
G0/G1, дуги G2/G3 с радиусом или IJK, выдержки G4, а также сплайны G5/G5.2 для
кубических Безье и рациональных NURBS. Параметры подаются в формате мм или
дюймов, автоматически конвертируются в Q16.16 и передаются в планировщик через
:c:func:`planner_enqueue_spline`. Для отладки :c:func:`gcode_parser_last_report`
возвращает человекочитаемое описание последней обработанной команды.
