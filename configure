#!/usr/bin/env sh
set -eu

prefix="/usr/local"
target_os="host"
endian="le"
enable_g5="yes"
enable_opcua="yes"
build_docs="yes"
extra_cppflags=""
extra_cflags="-O2"
extra_ldflags=""
extra_libs=""
cc="${CC:-cc}"
ar="${AR:-ar}"
ranlib="${RANLIB:-ranlib}"

usage() {
    cat <<USAGE
Usage: ./configure [options]
  --prefix=DIR           Installation prefix (default: /usr/local)
  --target-os=NAME       Target OS (host|qnx|vxworks|baget|qemu) (default: host)
  --endian=(le|be)       Endianness hint for Baget builds (default: le)
  --enable-g5            Enable Bézier/NURBS G-code support (default)
  --disable-g5           Disable Bézier/NURBS G-code support
  --enable-opcua         Enable OPC UA server (default)
  --disable-opcua        Disable OPC UA server
  --build-docs           Enable documentation build targets (default)
  --disable-docs         Disable documentation build targets
  --cc=COMPILER          Override compiler executable
  --ar=ARCHIVER          Override archiver executable
  --ranlib=RANLIB        Override ranlib executable
  --extra-cppflags=FLAGS Additional preprocessor flags
  --extra-cflags=FLAGS   Additional compiler flags
  --extra-ldflags=FLAGS  Additional linker flags
  --extra-libs=FLAGS     Additional libraries
  --help                 Show this help and exit
USAGE
}

for opt in "$@"; do
    case "$opt" in
        --prefix=*)
            prefix="${opt#*=}"
            ;;
        --target-os=*)
            target_os="${opt#*=}"
            ;;
        --endian=*)
            endian="${opt#*=}"
            ;;
        --enable-g5)
            enable_g5="yes"
            ;;
        --disable-g5)
            enable_g5="no"
            ;;
        --enable-opcua)
            enable_opcua="yes"
            ;;
        --disable-opcua)
            enable_opcua="no"
            ;;
        --build-docs)
            build_docs="yes"
            ;;
        --disable-docs)
            build_docs="no"
            ;;
        --cc=*)
            cc="${opt#*=}"
            ;;
        --ar=*)
            ar="${opt#*=}"
            ;;
        --ranlib=*)
            ranlib="${opt#*=}"
            ;;
        --extra-cppflags=*)
            extra_cppflags="${opt#*=}"
            ;;
        --extra-cflags=*)
            extra_cflags="${opt#*=}"
            ;;
        --extra-ldflags=*)
            extra_ldflags="${opt#*=}"
            ;;
        --extra-libs=*)
            extra_libs="${opt#*=}"
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $opt" >&2
            usage >&2
            exit 1
            ;;
    esac
done

case "$target_os" in
    host|qnx|vxworks|baget|qemu)
        ;;
    *)
        echo "Unsupported target-os: $target_os" >&2
        exit 1
        ;;
esac

case "$endian" in
    le|be)
        ;;
    *)
        echo "Unsupported endian option: $endian" >&2
        exit 1
        ;;
esac

enable_g5_flag=0
[ "$enable_g5" = "yes" ] && enable_g5_flag=1

enable_opcua_flag=0
[ "$enable_opcua" = "yes" ] && enable_opcua_flag=1

build_docs_flag=0
[ "$build_docs" = "yes" ] && build_docs_flag=1

cat > config.mk <<CONFIG
# Auto-generated by configure
PREFIX := $prefix
TARGET_OS := $target_os
ENDIAN := $endian
ENABLE_G5 := $enable_g5_flag
ENABLE_OPCUA := $enable_opcua_flag
BUILD_DOCS := $build_docs_flag
CC := $cc
AR := $ar
RANLIB := $ranlib
EXTRA_CPPFLAGS := $extra_cppflags
EXTRA_CFLAGS := $extra_cflags
EXTRA_LDFLAGS := $extra_ldflags
EXTRA_LIBS := $extra_libs
CONFIG

cat > config.status <<STATUS
prefix='$prefix'
target_os='$target_os'
endian='$endian'
enable_g5='$enable_g5'
enable_opcua='$enable_opcua'
build_docs='$build_docs'
cc='$cc'
ar='$ar'
ranlib='$ranlib'
extra_cppflags='$extra_cppflags'
extra_cflags='$extra_cflags'
extra_ldflags='$extra_ldflags'
extra_libs='$extra_libs'
STATUS

printf "Configuration summary\n"
printf "  prefix:            %s\n" "$prefix"
printf "  target OS:        %s\n" "$target_os"
printf "  endian:           %s\n" "$endian"
printf "  G-code G5:        %s\n" "$enable_g5"
printf "  OPC UA:           %s\n" "$enable_opcua"
printf "  docs:             %s\n" "$build_docs"
printf "  compiler:         %s\n" "$cc"
printf "  archiver:         %s\n" "$ar"
printf "  ranlib:           %s\n" "$ranlib"
printf "Run 'make' to build the project.\n"
